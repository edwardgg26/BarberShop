let paso=1;const pasoInicial=1,pasoFinal=3,diasNoTrabajo=[0],horasTrabajo={minima:8,maxima:20},cita={idUsuario:null,nombre:"",fecha:"",hora:"",servicios:[],barbero:null};function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPIBarberos(),consultarAPIServicios(),nombreCliente(),seleccionarFecha(),seleccionarHora()}function mostrarSeccion(){const e=document.querySelector(".mostrar");e&&(e.classList.remove("mostrar"),e.classList.add("ocultar")),pasoSeccion="#seccion-cita-"+paso;const a=document.querySelector(pasoSeccion);a.classList.remove("ocultar"),a.classList.add("mostrar");const t=document.querySelector(".active");t&&t.classList.remove("active");document.querySelectorAll(".page-item").item(paso-1).classList.add("active")}function tabs(){document.querySelectorAll(".page-link").forEach(e=>{e.addEventListener("click",e=>{paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()})})}function botonesPaginador(){const e=document.querySelector("#anterior"),a=document.querySelector("#siguiente");1==paso?(e.disabled=!0,a.disabled=!1):3==paso?(e.disabled=!1,a.disabled=!0,mostrarResumen()):(e.disabled=!1,a.disabled=!1),mostrarSeccion()}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",()=>{paso>=3||(paso++,botonesPaginador())})}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",()=>{paso<=1||(paso--,botonesPaginador())})}async function consultarAPIServicios(){try{const e="/api/servicios",a=await fetch(e);mostrarServicios(await a.json())}catch(e){console.log("Error al obtener servicios:",e)}}async function consultarAPIBarberos(){try{const e="/api/barberos",a=await fetch(e);mostrarBarberos(await a.json())}catch(e){console.log("Error al obtener servicios:",e)}}function mostrarBarberos(e){e.forEach(e=>{const{nombre:a,apellido:t}=e,n=document.createElement("OPTION");n.textContent=a+" "+t,n.value=JSON.stringify(e);const o=document.querySelector("#select-barbero");o.addEventListener("change",e=>{null!==o.value||"null"!==o.value?(cita.barbero=JSON.parse(e.target.value),borrarAlertas()):cita.barbero=null}),o.appendChild(n)})}function mostrarServicios(e){e.forEach(e=>{const{id:a,nombre:t,precio:n,duracion:o}=e,r=document.createElement("P");r.textContent=t,r.classList.add("fw-bold"),r.classList.add("text-break");const s=document.createElement("P");s.textContent="$"+n,s.classList.add("mb-0");const c=document.createElement("P");c.textContent=o+" minutos",c.classList.add("mb-0");const i=document.createElement("BUTTON");i.classList.add("btn"),i.classList.add("col-5"),i.classList.add("col-md-3"),i.classList.add("m-1"),i.dataset.bsToggle="button",i.appendChild(r),i.appendChild(s),i.appendChild(c),i.addEventListener("click",()=>{if(cita.servicios.includes(e)){const a=cita.servicios.indexOf(e);cita.servicios.splice(a,1)}else cita.servicios.push(e),borrarAlertas()}),document.querySelector("#contenedor-servicios").appendChild(i)})}function mostrarResumen(){const e=document.querySelector("#seccion-cita-3");if(e.innerHTML="",3===paso&&(Object.values(cita).includes("")||0===cita.servicios.length||Object.values(cita).includes(null)))return void mostrarAlerta("Faltan datos de la reserva.","danger");borrarAlertas();const a=document.createElement("H2");a.innerHTML="Resumen",a.classList.add("mb-4"),e.appendChild(a);const{nombre:t,fecha:n,hora:o,servicios:r,barbero:s}=cita,c=document.createElement("DIV"),i=document.createElement("H4");i.innerHTML="Servicios",i.classList.add("mb-4"),c.appendChild(i);const l={precioTotal:0,duracionTotal:0};r.forEach(e=>{l.duracionTotal+=parseInt(e.duracion),l.precioTotal+=parseFloat(e.precio);const a=document.createElement("DIV"),t=document.createElement("P");t.innerHTML='<span class="fw-bold">Nombre:</span> '+e.nombre;const n=document.createElement("P");n.innerHTML='<span class="fw-bold">Precio:</span> $'+e.precio;const o=document.createElement("P");o.innerHTML=`<span class="fw-bold">Duraci√≥n:</span> ${e.duracion} minutos`;const r=document.createElement("HR");a.appendChild(t),a.appendChild(n),a.appendChild(o),a.appendChild(r),c.appendChild(a)});const d=document.createElement("P");d.innerHTML='<span class="fw-bold">Nombre Cliente:</span> '+t;const u=new Date(n),m=u.getMonth(),p=u.getDate()+2,b=u.getFullYear(),h=new Date(Date.UTC(b,m,p)).toLocaleDateString("es-CO",{year:"numeric",month:"long",day:"2-digit",weekday:"long"}),v=document.createElement("P");v.innerHTML='<span class="fw-bold">Fecha:</span> '+h;const f=document.createElement("P");f.innerHTML='<span class="fw-bold">Hora:</span> '+o;const L=document.createElement("P");L.innerHTML='<span class="fw-bold">Barbero:</span> '+(s.nombre+" "+s.apellido);const g=document.createElement("P");g.innerHTML='<span class="fw-bold">Total a pagar:</span> $'+l.precioTotal;const E=document.createElement("P");E.innerHTML=`<span class="fw-bold">Duracion total:</span> ${l.duracionTotal} minutos`;const C=document.createElement("HR");c.appendChild(d),c.appendChild(v),c.appendChild(f),c.appendChild(L),c.appendChild(g),c.appendChild(E),c.appendChild(C),e.appendChild(c);const T=document.createElement("BUTTON");T.classList.add("btn"),T.classList.add("btn-primary"),T.classList.add("mb-5"),T.textContent="Reservar Cita",T.onclick=reservarCita,e.appendChild(T)}function nombreCliente(){cita.nombre=document.getElementById("nombre").value,cita.idUsuario=document.getElementById("id_usuario").value}function seleccionarFecha(){document.getElementById("fecha").addEventListener("input",e=>{const a=new Date(e.target.value).getUTCDay();diasNoTrabajo.includes(a)?(e.target.value="",cita.fecha="",mostrarAlerta("No se atiende los domingos.","danger")):(cita.fecha=e.target.value,borrarAlertas())})}function seleccionarHora(){document.getElementById("hora").addEventListener("input",e=>{const a=e.target.value.split(":");a[0]<horasTrabajo.minima||a[0]>=horasTrabajo.maxima?(mostrarAlerta("La barberia abre a las 8am y cierra a las 8pm.","danger"),e.target.value="",cita.hora=""):(cita.hora=e.target.value,borrarAlertas())})}function mostrarAlerta(e,a){const t=document.createElement("DIV");t.role="alert",t.classList.add(["alert"]),t.classList.add("alert-"+a),t.classList.add("alert-dismissible"),t.classList.add("fade"),t.classList.add("show");const n=document.createElement("P");n.textContent=e;const o=document.createElement("BUTTON");o.classList.add("btn-close"),o.dataset.bsDismiss="alert",o.ariaLabel="Close",t.appendChild(n),t.appendChild(o),document.querySelector("#contenedor-alertas").appendChild(t)}function borrarAlertas(){document.querySelectorAll(".alert").forEach(e=>e.remove())}async function reservarCita(){const{idUsuario:e,fecha:a,hora:t,barbero:n,servicios:o}=cita,r=o.map(e=>e.id),s=new FormData;s.append("fecha",a),s.append("hora",t),s.append("id_usuario",parseInt(e)),s.append("id_barbero",n.id),s.append("servicios",r);try{const e="/api/citas",a=await fetch(e,{method:"POST",body:s});(await a.json()).resultado&&Swal.fire({title:"Cita Reservada!",text:"Tu cita ha sido reservada con exito!",icon:"success"}).then(()=>{window.location.reload()})}catch(e){Swal.fire({icon:"error",title:"Error...",text:"Hubo un error al crear la reserva..."})}}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));